# Tushare MCP服务器接口大模型调用问题排查报告

## 问题概述

大模型在调用Tushare MCP服务器的四个接口（idx_factor_pro、index_monthly、moneyflow_mkt_dc、moneyflow_hsgt）时遇到调用失败的情况。

## 问题分析

通过一系列测试，我们发现以下问题：

### 1. 参数验证问题

- **index_monthly和idx_factor_pro接口**：原始实现中，参数验证允许只提供start_date参数，但Tushare API内部要求必须提供ts_code或trade_date参数之一，导致调用失败。
- **moneyflow_hsgt接口**：必须提供trade_date或start_date参数之一，否则调用失败。
- **moneyflow_mkt_dc接口**：所有参数都是可选的，可以不提供任何参数。

### 2. 日期格式问题

- 所有日期参数必须为YYYYMMDD格式，例如：20240101
- 错误的日期格式（如2024-01-01）会导致调用失败

### 3. 参数名问题

- Python函数会对错误的参数名抛出异常，例如使用`code`而非`ts_code`
- 大模型需要使用正确的参数名进行调用

## 解决方案

### 1. 修改参数验证逻辑

对于index_monthly和idx_factor_pro接口，修改参数验证逻辑，确保必须提供ts_code或trade_date参数之一：

```python
# 修改前
if ts_code is None and trade_date is None and start_date is None:
    return json.dumps({"error": "必须提供以下参数之一: ts_code, trade_date, start_date"})

# 修改后
if ts_code is None and trade_date is None:
    return json.dumps({"error": "必须提供以下参数之一: ts_code, trade_date"})
```

### 2. 添加日期格式验证

为所有接口添加日期格式验证，确保日期参数为YYYYMMDD格式：

```python
# 日期格式验证
date_fields = {"trade_date": trade_date, "start_date": start_date, "end_date": end_date}
for field_name, date_value in date_fields.items():
    if date_value is not None and not (len(date_value) == 8 and date_value.isdigit()):
        return json.dumps({"error": f"参数 {field_name} 的日期格式不正确，必须为YYYYMMDD格式，例如: 20240101"})
```

### 3. 完善文档说明

为每个接口添加详细的参数说明、示例调用和注意事项，包括：

- 参数的必需性说明
- 日期格式要求
- 示例调用代码
- 数据说明

## 大模型调用建议

### 1. index_monthly接口

```python
# 必须提供ts_code或trade_date参数之一
index_monthly(ts_code="000001.SH", start_date="20240101", end_date="20240131")
# 或
index_monthly(trade_date="20240101")
```

### 2. idx_factor_pro接口

```python
# 必须提供ts_code或trade_date参数之一
idx_factor_pro(ts_code="000001.SH", start_date="20240101", end_date="20240131")
# 或
idx_factor_pro(trade_date="20240101")
```

### 3. moneyflow_mkt_dc接口

```python
# 所有参数都是可选的
moneyflow_mkt_dc()  # 返回默认数据
# 或
moneyflow_mkt_dc(start_date="20240101", end_date="20240131")
```

### 4. moneyflow_hsgt接口

```python
# 必须提供trade_date或start_date参数之一
moneyflow_hsgt(start_date="20240101", end_date="20240131")
# 或
moneyflow_hsgt(trade_date="20240101")
```

## 测试验证

通过一系列测试验证了修复后的接口能够正确处理各种错误情况，并提供明确的错误信息：

1. 缺少必需参数时返回明确的错误信息
2. 错误的日期格式时返回明确的错误信息
3. 正确的参数调用能够成功返回数据
4. 错误的参数名会被Python拒绝，抛出异常

## 结论

修复后的接口能够更好地支持大模型调用，提供更明确的错误信息和参数要求。大模型在调用这些接口时，需要遵循上述建议，确保提供正确的参数和格式。